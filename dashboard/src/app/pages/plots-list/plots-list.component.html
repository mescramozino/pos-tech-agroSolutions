<div class="plots-page">
  <nav class="breadcrumb">
    <a routerLink="/painel">Dashboard</a>
    <span class="breadcrumb-sep">/</span>
    <span class="breadcrumb-current">Talh√µes</span>
  </nav>

  <div class="plots-header">
    <h1 class="plots-title">Gest√£o de Talh√µes</h1>
    <button type="button" class="btn btn-primary btn-add" (click)="openCreateModal()">
      <span class="btn-add-icon">‚ûï</span>
      Novo
    </button>
  </div>

  @if (error()) {
    <p class="plots-error">{{ error() }}</p>
  }

  <div class="card card-filters">
    <div class="filter-search-wrap">
      <span class="filter-search-icon">üîç</span>
      <input
        type="text"
        class="filter-search-input"
        placeholder="Filtrar por nome, cultura ou propriedade"
        [ngModel]="searchText()"
        (ngModelChange)="setSearch($event)"
      />
    </div>
    <div class="filter-row">
      <div class="filter-group">
        <label class="filter-label">P√°gina</label>
        <select
          class="filter-select"
          [ngModel]="page()"
          (ngModelChange)="setPage(+$event)"
        >
          @for (p of pageNumbers(); track p) {
            <option [value]="p">{{ p }}</option>
          }
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">Tamanho da P√°gina</label>
        <select
          class="filter-select"
          [ngModel]="pageSize()"
          (ngModelChange)="pageSize.set(+$event); page.set(1)"
        >
          @for (size of pageSizeOptions; track size) {
            <option [value]="size">{{ size }}</option>
          }
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">Ordenar por</label>
        <select
          class="filter-select"
          [ngModel]="sortBy()"
          (ngModelChange)="sortBy.set($event)"
        >
          @for (opt of sortByOptions; track opt.value) {
            <option [value]="opt.value">{{ opt.label }}</option>
          }
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">Dire√ß√£o</label>
        <select
          class="filter-select"
          [ngModel]="sortDir()"
          (ngModelChange)="sortDir.set($event)"
        >
          <option value="asc">Ascendente</option>
          <option value="desc">Descendente</option>
        </select>
      </div>
      <div class="filter-apply-wrap">
        <button type="button" class="btn btn-primary" (click)="applyFilters()">
          Aplicar
        </button>
      </div>
    </div>
  </div>

  <div class="card card-table">
    <table class="plots-table">
      <thead>
        <tr>
          <th>Nome do Talh√£o</th>
          <th>Cultura</th>
          <th>Propriedade</th>
          <th>Criado em</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        @if (loading()) {
          <tr>
            <td colspan="5" class="table-loading">Carregando‚Ä¶</td>
          </tr>
        } @else if (paginated().length === 0) {
          <tr>
            <td colspan="5" class="table-empty">Nenhum talh√£o encontrado.</td>
          </tr>
        } @else {
          @for (item of paginated(); track item.plot.id) {
            <tr>
              <td>
                <a [routerLink]="['/plots', item.plot.id]" class="table-link-name">{{ item.plot.name }}</a>
              </td>
              <td>{{ item.plot.culture }}</td>
              <td>
                <a [routerLink]="['/properties', item.property.id]" class="table-link-property">{{ item.property.name }}</a>
              </td>
              <td>{{ item.plot.createdAt | date:'dd/MM/yyyy, HH:mm' }}</td>
              <td class="table-actions">
                <button type="button" class="btn-action btn-edit" (click)="openEditModal(item)">
                  <span>‚úèÔ∏è</span> Editar
                </button>
                <button type="button" class="btn-action btn-delete" (click)="openDeleteModal(item)">
                  <span>üóëÔ∏è</span> Excluir
                </button>
              </td>
            </tr>
          }
        }
      </tbody>
    </table>

    <div class="table-footer">
      <span class="footer-info">
        @if (loading()) {
          Carregando talh√µes‚Ä¶
        } @else {
          {{ totalFiltered() }} talh√£o(√µes)
        }
      </span>
      <div class="footer-nav">
        <button
          type="button"
          class="btn btn-outline"
          [disabled]="!canPrev()"
          (click)="prevPage()"
        >
          Anterior
        </button>
        <button
          type="button"
          class="btn btn-outline"
          [disabled]="!canNext()"
          (click)="nextPage()"
        >
          Pr√≥xima
        </button>
      </div>
    </div>
  </div>

  @if (formModalOpen()) {
    <div class="modal-overlay" (click)="closeFormModal()" role="button" tabindex="0">
      <div class="modal-panel" (click)="$event.stopPropagation()" role="dialog" aria-labelledby="form-modal-title">
        <div class="modal-header">
          <h2 id="form-modal-title" class="modal-title">
            {{ editingItem() ? 'Editar Talh√£o' : 'Novo Talh√£o' }}
          </h2>
          <button type="button" class="modal-close" (click)="closeFormModal()" aria-label="Fechar">‚úñÔ∏è</button>
        </div>
        <form (ngSubmit)="savePlot()" class="modal-body">
          @if (formError()) {
            <p class="form-error-inline">{{ formError() }}</p>
          }
          @if (editingItem()) {
            <div class="modal-form-group">
              <label class="modal-label">Propriedade</label>
              <input type="text" class="modal-input" [value]="editingItem()!.property.name" readonly disabled />
            </div>
          } @else {
            <div class="modal-form-group">
              <label class="modal-label">Propriedade *</label>
              <select class="modal-input" [(ngModel)]="formPropertyId" name="formPropertyId" required>
                @for (prop of properties(); track prop.id) {
                  <option [value]="prop.id">{{ prop.name }}</option>
                }
              </select>
              <span class="modal-helper">Propriedade √† qual o talh√£o pertence</span>
            </div>
          }
          <div class="modal-form-group">
            <label class="modal-label">Nome do Talh√£o *</label>
            <input type="text" class="modal-input" [(ngModel)]="formName" name="formName" placeholder="ex.: Talh√£o Norte" required />
            <span class="modal-helper">Nome identificador do talh√£o</span>
          </div>
          <div class="modal-form-group">
            <label class="modal-label">Cultura *</label>
            <input type="text" class="modal-input" [(ngModel)]="formCulture" name="formCulture" placeholder="ex.: Soja" required />
            <span class="modal-helper">Cultura cultivada no talh√£o</span>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary btn-modal-save" [disabled]="formSaving()">
              <span>‚úîÔ∏è</span> {{ editingItem() ? 'Salvar Altera√ß√µes' : 'Salvar' }}
            </button>
            <button type="button" class="btn btn-modal-close" (click)="closeFormModal()">
              <span>‚úñÔ∏è</span> Fechar
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  @if (deleteModalOpen()) {
    <div class="modal-overlay modal-overlay-delete" (click)="closeDeleteModal()" role="button" tabindex="0">
      <div class="modal-panel modal-panel-sm" (click)="$event.stopPropagation()" role="dialog" aria-labelledby="delete-modal-title">
        <div class="modal-header">
          <h2 id="delete-modal-title" class="modal-title">Confirmar Exclus√£o</h2>
          <button type="button" class="modal-close" (click)="closeDeleteModal()" aria-label="Fechar">‚úñÔ∏è</button>
        </div>
        <div class="modal-body">
          <p class="modal-delete-text">Esta a√ß√£o n√£o poder√° ser desfeita. Deseja realmente excluir este talh√£o?</p>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger btn-modal-delete" (click)="confirmDelete()">
              <span>üóëÔ∏è</span> Excluir
            </button>
            <button type="button" class="btn btn-outline" (click)="closeDeleteModal()">Cancelar</button>
          </div>
        </div>
      </div>
    </div>
  }
</div>
